<wiki:toc />
----
= General View=
<b>GISOO</b> stand for <b>G</b>raphical <b>I</b>ntegration of <b>S</b>imulink snd C<b>OO</b>ja and as the name represent each simulation in GISOO should be consist of the combination of two simulations, one in Cooja and one in Simulink which are synchronous together with the possibility of data communication. 
In fact all the wireless system (which also can contain the controller) will be simulated in the Cooja and the plant will be simulated in Simulink, and whenever simulated system in Cooja needs to measure some variables in plant or actuate some actuators there, the sensor or actuator mote in Cooja will send the request for sensor value or send the actuation data to their mirror sensor or actuator in the Simulink model which are in contact with the plant model and can receive the requested sensor data or apply the actuation value. The following picture show the genera view of the the GISOO which can show the mirror motes in Cooja and Simulink and the location of the motes in the relation with the plant. (The following picture show the situation that the controller located in one of the motes, but it is also possible to locate the controller in a PC)

<p align="center">   
<img src="https://kth-gisoo.googlecode.com/svn/trunk/images/implementation_details/DesignedModel.png"  height="682px" width="637px">
<p>

In order to have the mentioned system worked, we needs to be able to have a proper data communication and also both systems should work synchronously. So the main facts to create GISOO are providing a proper data communication system and accurate synchronization. The following sections will explain the details of designed and implemented parts to achieve these goals. Since the data communication is also used for the synchronization, firstly we need to understand the data communication details.

= Data Communication=
In the first step to prepare the simulation in GISOO we need to add all the wireless motes to the Cooja environment and then in the next step we need to activate the provided GISOO-plug-in in Cooja (SimmulinkConnector) to handle the data communication and synchronization for GISOO. This plug-in will create a UDP port which the port number is equal to "18000+Mote-id" and it will listen on this port to receive the data from Simulink which are related to this mote. It means that each mote in Cooja will have its own specific UDP port to receive data. 

<p align="center">   
<img src="https://kth-gisoo.googlecode.com/svn/trunk/images/implementation_details/Cooja_Mote_PortNumber.png"  >
<p>

On the other side Simulink model has different situation and all the Model will receive data from one predefined UDP port which by default is port number 55555. This means that all the data which should be received by Simulink or even specific part of Simulink model should be sent to this port.

<p align="center">   
<img src="https://kth-gisoo.googlecode.com/svn/trunk/images/implementation_details/SimulinkReceivePortnumber.png" height="682px" width="737px" >
<p>

== Simulation procedure ==

In GISOO Cooja is responsible to control the simulation procedure. It means that Cooja will start simulating the wireless system until the moment that one of the motes in Cooja need to send or receives some data from plant model. This can happen in four situations:

  * A sensor mote need to sense some sensor data.
  * An actuator mote needs to apply some actuation values on the plant
  * A mote needs to send some serial data.
  * A mote needs to receive some serial data.

In any of these situations a mote in Cooja will send a message to the Simulink model to inform Simulink that at which moment which kind of action in which mote is required. To achieve this aim an especial message structure has been designed. This message contains four different parts: 

  * Simulation time
  * Mote-Pin-ID 
  * Actuation value (uValue)
  * Serial data

<b>Simulation time:</b> In the message structure the first four bytes considered for carrying the Simulation time (in millisecond). In fact Cooja will run until the moment that a mote needs an especial communication with Simulink, then it will generate a message and add the time of simulation in Cooja to the beginning of the message. On the other side, Simulink will pause the simulation until it receive a message from Cooja. Then in the first step it will extract the Cooja time from the beginning the the message and will run the Simulink simulation to reach that specific moment. This procedure will be explained more in the synchronization explanation in this page.

<b>Mote-Pin-ID:</b> When ever a message generated by a mote in Cooja, Simulink as a receiver should be aware that this message came from which mote and should affect which part of that mote. For instance when a mote with id=4 needs to read data from its ADC1, in the message which will be send to Simulink both of the "mote-id" and "ADC1 (which we called it pin number)" should be clear. For this aim we generate a number by name of mote-pin-id which has been created by this method:

mote-pin-id = Mote-id*100 + pin number

and considered pin-ids are:

  * ADC0 - ADC12 = 0 - 12
  * DAC0 - DAC1  = 16 - 17
  * Serial data to be sent to Simulink = 18
  * Serial data to be received from Simulink = 19

<b>Actuation value (uValue):</b> Although some the messages will be used to apply an actuation value to the plant because of need of fix message format in GISOO, these four bytes will be inside of all the messages by they will receive value and also their value will be used only when a mote in Cooja wants to apply an actuation value to the plant.

<b>Serial data:</b> for the same reason as it mention for actuation value, all the message will carry 16 bytes of serial message but they will only used when some serial data is needed to be transmitted from Cooja to Simulink or in vice versa.

The following picture shows a schema of the designed message structure for GISOO.


<p align="center">   
<img src="https://kth-gisoo.googlecode.com/svn/trunk/images/implementation_details/MSGStructure.png"  >
<p>

= Synchronization =
Another important factor for GISOO is its accurate synchronization system. In GISOO as it has been mentioned, the Cooja will control the simulation time and for this reason Cooja will run its simulation until the moment that a mote in Cooja needs to send or receive some data to/from Simulink. In this moment the GISOO plugin in Cooja for that mote will create a message and send it to Simulink which contain the accurate time of simulation time in Cooja (in millisecond). As soon as the plug-in send the message, it will pause the simulation in that moment to receive a reply from Simulink. This reply can be a sensor value or serial data or an acknowledgement, but receiving a data is important otherwise the Cooja will not continue its Simulation.
This pause in Cooja always create by executing a "receive" command after sending a data. Since the "receive"command is a blocking function the simulation will stay on that moment until it could read some data and pass that part. The following code shows the part of code winch send a request for an ADC value and make a pause in simulation until the ADC for that moment be receives. 

{{{
protected int adcRequestSender(byte[] message, DatagramSocket dgSocket) {

        try {
            InetAddress IPAddress = InetAddress.getByName("localhost");
            DatagramPacket dgPacket = new DatagramPacket(message, message.length, IPAddress, 55555);
            dgSocket.send(dgPacket);
        } catch (IOException ex) {
            System.out.println("Error in sending dgPacket in adcRequestSender!!");
        }
        byte[] receivedValue = new byte[4];
        DatagramPacket receivedPacket = new DatagramPacket(receivedValue, receivedValue.length);
        try {

            dgSocket.receive(receivedPacket); //This line will make a pause in Cooja's simulation until the sensor data be received.

        } catch (IOException ex) {
            System.out.println("Error in receive UDP data adcRequestSender!!");
            System.out.println(ex.getMessage());
        }
        byte[] data = receivedPacket.getData();
        return (bytes2Int1(data));
    }
}}}

On the other side the Simulink is in the pause mode from the beginning and it will wait until it receives a message from Simulink. As soon as it receive a message, it will extract the time of simulation in Cooja and then it will continue the Simulation simulation until it reach the Simulation time in Cooja and then send back the requested data or apply the actuation data in that moment. In fact the time duration between two messages is the duration that Simulink can run the simulation independent of the simulation Cooja and normally simulation is much faster than simulation in Cooja so the Simulink can catch the simulation time in Cooja in very short period of time.(It will depend on the complexity of the plant model in Simulink). 
The following picture shows the combination of Synchronization and message communication in GISOO.

<p align="center">   
<img src="https://kth-gisoo.googlecode.com/svn/trunk/images/implementation_details/MSGTimeLine.png" height="782px" >
<p>


= GISOO Simulink Library Blocks =
GISOO uses its specific Simulink library and this part will explain about the details of designed system for achieving the proper functionality in simulation. 
== Synchronization and data communication ==
GISOO-Simulink-library contains a main block to handle both of the synchronization and the data communication (receiving the data in Simulink) which known as "CoojaPlatform". This block Simulate the Cooja environment and motes in side the Simulink and also if we needed to implemented the controller model to the Simulink it should also be added inside this block. And the plant model should be located out of this block. More explanation and examples can be find in [https://code.google.com/p/kth-gisoo/wiki/Samples  here] and [https://code.google.com/p/kth-gisoo/wiki/Samples#Double-tank_system_with_the_controller_in_PC  here].
This block is a do-while block which can pause the simulation of the plant model "while" it has not receive a new time from Cooja and "do" continue the simulation of the plant model when it receive a new simulation time from Cooja.

This block also should be able to continuously receive the message from Cooja and for this aim we add additional parts which can handle the receiving the data.
The following picture shows the "GISOO_Simulation_Environment" block.
<p align="center">   
<img src="https://kth-gisoo.googlecode.com/svn/trunk/images/implementation_details/GISOO_Simulation_Environment.png"  >
<p>

Inside the "GISOO_Simulation_Environment" has been shown in the following picture. As it has shown it contains a CoojaConnector block which is responsible for receiving the data from Cooja and also it will synchronize the Simulink with Cooja. The other block is "SynchronizerLoop" which just control the do while loop in Simulink.

<p align="center">   
<img src="https://kth-gisoo.googlecode.com/svn/trunk/images/implementation_details/CoojaConnector.png"  >
<p>

The next picture show the entire of the "CoojaConnector". As it has been marked in the picture This block will receive messages from Cooja and extract the SimulationTime, mote-pin-id, uValue and, Serial data and also compare the Simulation time in Simulink with the Simulation time in Cooja and if Simulink is behind it will continue simulation to reach the proper time. The three blocks in the top right side of the picture shows the maximum number of the iteration that the while loop will do. This number will config the maximum time that Simulink can wait to receive a message from Cooja otherwise the Simulink will consider that the communication with Cooja and to avoid the infinitive simulation loop, the stop block will stop the Simulink Simulation with showing a message on the screen. (If in the scenario you need bigger time intervals to receive messages from Cooja, you can increase the default value of this block, which is 3000 in the following figure.) 
<p align="center">   
<img src="https://kth-gisoo.googlecode.com/svn/trunk/images/implementation_details/Inside_GISOO_Simulation_Env.png"  >
<p>

The Following picture shows the message created by Stop block when it could not receive a message from Cooja before it reach the maximum number of its iteration.

<p align="center">   
<img src="https://kth-gisoo.googlecode.com/svn/trunk/images/implementation_details/SimulationStop.png"  >
<p>

== Mote structure ==


<p align="center">   
<img src="https://kth-gisoo.googlecode.com/svn/trunk/images/implementation_details/Mote.png">
<p>